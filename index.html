<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Animator Pro Ultra v42.4 (Ultimate Stability)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        :root { --primary: #2563eb; --active-key: #3b82f6; --success: #10b981; --danger: #ef4444; --dark: #1e293b; --bg: #f1f5f9; --border: #e2e8f0; --warning: #f59e0b; }
        body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; height: 100vh; background: var(--bg); margin: 0; overflow: hidden; color: #334155; }
        
        /* „Éó„É¨„Ç§„É§„Éº„É¢„Éº„ÉâÔºöÂ§±ÊïóÊôÇ„Å´Áúü„Å£ÁôΩ„Å´„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜËÉåÊôØ„ÇíÁ¢∫‰øù */
        body.player-mode .sidebar, body.player-mode #timelineResizer, body.player-mode .timeline-container { display: none !important; }
        body.player-mode .top-area { padding: 0; }
        body.player-mode .canvas-area { background: #000; border-radius: 0; flex: 1; height: 100vh; }

        .top-area { display: flex; flex: 1; min-height: 0; padding: 5px; gap: 8px; overflow: hidden; }
        .sidebar { background: white; width: 340px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow-y: auto; padding: 10px; gap: 8px; z-index: 500; }
        .canvas-area { flex: 1; background: #cbd5e1; border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; cursor: grab; }
        #canvas-wrapper { background: #ffffff; box-shadow: 0 10px 30px rgba(0,0,0,0.1); position: relative; line-height: 0; transform-origin: center center; }
        canvas { display: block; }
        
        #timelineResizer { height: 6px; background: #e2e8f0; cursor: ns-resize; transition: background 0.2s; z-index: 600; flex-shrink: 0; }
        .timeline-container { height: 260px; min-height: 50px; background: white; border-top: 1px solid var(--border); display: flex; flex-direction: column; z-index: 400; flex-shrink: 0; overflow: hidden; }
        .timeline-scroll-area { flex: 1; overflow: auto; position: relative; }
        .timeline-inner-width { width: 1800px; position: relative; } 
        .timeline-header-row { display: flex; background: #f8fafc; border-bottom: 1px solid var(--border); height: 30px; align-items: center; position: sticky; top: 0; z-index: 350; }
        .timeline-label-col { position: sticky; left: 0; width: 170px; min-width: 170px; border-right: 2px solid #cbd5e1; height: 100%; display: flex; align-items: center; padding-left: 10px; font-size: 10px; font-weight: bold; color: #64748b; background: #f1f5f9; z-index: 360; }
        .timeline-ruler { flex: 1; height: 100%; position: relative; cursor: crosshair; }
        .ruler-mark { position: absolute; top: 5px; font-size: 9px; border-left: 1px solid #cbd5e1; padding-left: 2px; height: 20px; color: #94a3b8; }
        .timeline-row { display: flex; height: 42px; align-items: center; border-bottom: 1px solid #f1f5f9; background: #fff; position: relative; }
        .timeline-row.active { background: #eff6ff; }
        .track-handle { position: sticky; left: 0; width: 170px; min-width: 170px; height: 100%; border-right: 2px solid #cbd5e1; display: flex; align-items: center; padding-left: 10px; font-size: 10px; cursor: grab; user-select: none; background: white; z-index: 200; gap: 6px; }
        .timeline-track { flex: 1; height: 100%; position: relative; pointer-events: all; cursor: cell; z-index: 10; }
        .track-inner-line { position: absolute; top: 50%; left: 10px; right: 10px; height: 4px; background: #e2e8f0; border-radius: 2px; transform: translateY(-50%); pointer-events: none; }
        .timeline-key { position: absolute; width: 10px; height: 10px; background: white; border: 2px solid var(--primary); border-radius: 50%; top: 50%; transform: translate(-50%, -50%); cursor: ew-resize; z-index: 100; }
        .timeline-key.selected { background: var(--active-key); scale: 1.3; border-color: white; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .key-time-tag { position: absolute; top: -14px; left: 50%; transform: translateX(-50%); font-size: 8px; color: var(--primary); font-weight: bold; pointer-events: none; white-space: nowrap; }
        .playhead { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--danger); z-index: 1000; pointer-events: none; }
        
        .accordion-item { border: 1px solid var(--border); border-radius: 6px; overflow: hidden; margin-bottom: 5px; flex-shrink: 0; }
        .accordion-header { background: #f8fafc; padding: 8px 10px; font-size: 11px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; user-select: none; border-bottom: 1px solid var(--border); }
        .accordion-content { padding: 8px; background: #fff; }
        .setting-card { background: #f8fafc; padding: 8px; border-radius: 6px; border: 1px solid #edf2f7; margin-bottom: 5px; }
        .num-in { width: 55px; border: 1px solid #ddd; padding: 2px 4px; border-radius: 3px; font-size: 11px; font-family: monospace; }
        .asset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 5px; }
        .btn-asset { height: 30px; background: #fff; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .btn-asset.loaded { border-color: var(--success); background: #f0fdf4; color: var(--success); }
        button { cursor: pointer; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; font-weight: 600; }
        .btn-p { background: var(--primary); color: white; }
        .btn-s { background: #64748b; color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-success { background: var(--success); color: white; }
        .obj-label-sm { font-size: 10px; color: #64748b; font-weight: bold; min-width: 45px; display: inline-block; }
        #recIndicator { display: none; position: absolute; top: 10px; right: 10px; background: rgba(239, 68, 68, 0.8); color: white; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; animation: pulse 1s infinite; z-index: 1100; }
        #exitPlayer { display: none; position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.5); color: white; padding: 5px 10px; border-radius: 4px; z-index: 2000; text-decoration: none; font-size: 10px; }
        body.player-mode #exitPlayer { display: block; }
    </style>
</head>
<body>

    <div id="recIndicator">üî¥ RECORDING...</div>
    <a href="?" id="exitPlayer">‚úï Exit Player Mode</a>

    <div class="top-area">
        <div class="sidebar">
            <div style="display:flex; justify-content:space-between; align-items:center; padding: 2px;">
                <h3 style="font-size:12px; margin:0;">Animator Pro v42.4</h3>
                <button class="btn-s" onclick="undo()">‚Ü© Undo</button>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAcc('acc-share')">SHARE & OUTPUT üì§ <span>‚ñº</span></div>
                <div class="accordion-content" id="acc-share">
                    <button class="btn-success" style="width:100%; padding:10px; margin-bottom:8px;" onclick="generateShareUrl()">üöÄ Share via URL (Small Only)</button>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:4px; margin-bottom:8px;">
                        <button class="btn-p" onclick="copyProjectData()">üìã Copy Data</button>
                        <button class="btn-warning" onclick="loadFromGistPrompt()">üì• Gist Load</button>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:4px;">
                        <button class="btn-s" onclick="exportImage()">üì∏ PNG</button>
                        <button class="btn-danger" id="btnRecord" onclick="toggleRecord()">üé• REC</button>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAcc('acc-assets')">DEFAULT ICONS üõ°Ô∏è <span>‚ñº</span></div>
                <div class="accordion-content" id="acc-assets">
                    <div class="asset-grid" id="assetGrid"></div>
                    <input type="file" id="assetBatch" multiple style="font-size:9px; width:100%; margin-top:8px;">
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAcc('acc-proj')">PROJECT FILES üìÅ <span>‚ñº</span></div>
                <div class="accordion-content" id="acc-proj">
                    <div style="display:flex; gap:4px; margin-bottom:8px;">
                        <button class="btn-p" style="flex:1;" onclick="exportProject()">üíæ Save File</button>
                        <button class="btn-s" style="flex:1;" onclick="importProject()">üìÇ Load File</button>
                    </div>
                    <p style="font-size:10px; margin:0;">Canvas Background:</p>
                    <input type="file" id="bgFile" accept="image/*" style="font-size:9px; width:100%;">
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAcc('acc-settings')">OBJECT SETTINGS <span>‚ñº</span></div>
                <div class="accordion-content" id="acc-settings">
                    <div id="settingsPanel" style="display:none;">
                        <div class="setting-card">
                            <input type="text" id="objNameIn" style="width:100%; padding:4px; font-size:11px;" oninput="syncName(this.value)">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:4px; margin-top:5px;">
                                <button class="btn-s" onclick="copyItem()">Copy</button>
                                <button class="btn-s" onclick="pasteItem()">Paste</button>
                                <button id="btnTrackLock" class="btn-s" onclick="toggleMainLock()">üîì Lock</button>
                                <button class="btn-danger" onclick="delObj()">Del</button>
                            </div>
                        </div>
                        <div id="keySettings" class="setting-card">
                            <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                                <span class="obj-label-sm">Time(s):</span>
                                <input type="text" id="pKeyTime" class="num-in" style="font-weight:bold;" oninput="sync('pKeyTime')">
                            </div>
                            <div style="display:flex; gap:5px; margin-bottom:5px;">
                                <span class="obj-label-sm">X:</span><input type="text" id="pPosX" class="num-in" oninput="sync('pPosX')">
                                <span class="obj-label-sm">Y:</span><input type="text" id="pPosY" class="num-in" oninput="sync('pPosY')">
                            </div>
                            <div style="font-size:10px; margin-bottom:5px;">
                                <span class="obj-label-sm">Rot:</span>
                                <input type="range" id="pRot" min="0" max="360" step="1" oninput="sync('pRot')"> 
                                <input type="text" id="pRot_n" class="num-in" style="width:35px" oninput="sync('pRot_n')">
                            </div>
                            <div style="display:flex; gap:5px; margin-bottom:5px;">
                                <span class="obj-label-sm">Dur:</span><input type="text" id="pDur" class="num-in" oninput="sync('pDur')">
                                <span class="obj-label-sm">Wait:</span><input type="text" id="pWait" class="num-in" oninput="sync('pWait')">
                            </div>
                            <button class="btn-danger" style="width:100%; margin-top:5px;" onclick="deleteKey()">Delete Key (Del)</button>
                        </div>
                    </div>
                    <div id="noSelectMsg" style="font-size:10px; color:#999; text-align:center; padding:10px;">Select a track or keyframe</div>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAcc('acc-add')">ADD ELEMENTS <span>‚ñº</span></div>
                <div class="accordion-content" id="acc-add">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:4px;">
                        <button class="btn-s" onclick="triggerFile()">Img</button>
                        <button class="btn-s" onclick="addObj('circle')">Circle</button>
                        <button class="btn-s" onclick="addObj('rect')">Square</button>
                        <button class="btn-s" onclick="addObj('arrow')">Arrow</button>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:5px; margin-top:auto; padding-top:10px;">
                <button class="btn-p" style="flex:2; font-size:14px; padding:12px;" onclick="play()">‚ñ∂ PLAY</button>
                <button class="btn-s" style="flex:1; background:#ef4444;" onclick="stopAnim()">‚ñ† STOP</button>
            </div>
        </div>

        <div class="canvas-area" id="viewport">
            <div id="canvas-wrapper"><canvas id="canvas"></canvas></div>
        </div>
    </div>

    <div id="timelineResizer"></div>
    <div class="timeline-container">
        <div class="timeline-scroll-area">
            <div class="timeline-inner-width">
                <div class="timeline-header-row">
                    <div class="timeline-label-col">TRACKS</div>
                    <div class="timeline-ruler" id="timelineRuler" onmousedown="onTimelineDown(event)"></div>
                </div>
                <div id="timelineBody"><div class="playhead" id="playhead"></div></div>
            </div>
        </div>
    </div>

    <div id="editorModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000;">
        <div style="background: white; padding: 20px; border-radius: 8px; display: flex; flex-direction: column;">
            <div class="crop-container" style="width: 600px; height: 400px; background: #000;"><img id="imgEdit"></div>
            <button class="btn-p" style="margin-top:10px;" onclick="finishEdit()">Apply</button>
        </div>
    </div>
    <input type="file" id="iconFile" style="display:none">
    <input type="file" id="loadInput" style="display:none">

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
    const wrapper = document.getElementById('canvas-wrapper'), P_SEC = 40, TL_LABEL_W = 170, SNAP = 0.1;
    let objects = [], bg = { el: new Image(), data: null }, history = [], library = {};
    let activeId = null, selectedIndices = [], isPlaying = false, currentTime = 0, canvasScale = 1.0;
    let dragInfo = { type: null }; let mediaRecorder = null, recordedChunks = []; let cropper = null;

    function init() {
        canvas.width = 800; canvas.height = 800;
        setupKeyboard(); setupZoom(); setupResizer(); initLibraryUI();
        checkUrlParams(); draw(); updateTimeline();
    }

    function initLibraryUI() {
        const grid = document.getElementById('assetGrid');
        if(!grid) return; grid.innerHTML = "";
        const names = ["D1", "D2", "D3", "D4", "H1", "H2", "MT", "ST", "„Çø„Ç≤„Çµ"];
        names.forEach(name => {
            const btn = document.createElement('button');
            btn.className = 'btn-asset' + (library[name] ? ' loaded' : '');
            btn.innerText = name; btn.onclick = () => addFromLibrary(name);
            grid.appendChild(btn);
        });
    }

    function addFromLibrary(name) {
        if(!library[name]) return alert("Upload icons first.");
        const img = new Image();
        img.onload = () => {
            const id = Date.now();
            objects.unshift({id, type:'image', el:img, src:library[name], name, visible:true, locked:false, delay:0, points:[{x:400,y:400,rot:0,dur:0,wait:0.5,sx:1,sy:1,a:1}]});
            select(id, 0); updateTimeline();
        };
        img.src = library[name];
    }

    document.getElementById('assetBatch').onchange = (e) => {
        Array.from(e.target.files).forEach(file => {
            const r = new FileReader();
            r.onload = (ev) => {
                const names = ["D1", "D2", "D3", "D4", "H1", "H2", "MT", "ST", "„Çø„Ç≤„Çµ"];
                const match = names.find(n => file.name.toUpperCase().includes(n));
                if(match) { library[match] = ev.target.result; initLibraryUI(); }
            };
            r.readAsDataURL(file);
        });
    };

    // --- üöÄ GitHub Gist ÂÆâÂÆöË™≠Ëæº„É≠„Ç∏„ÉÉ„ÇØ ---
    async function checkUrlParams() {
        const hash = window.location.hash;
        if (hash.startsWith("#gist=")) {
            const gistId = hash.replace("#gist=", "");
            try {
                const res = await fetch(`https://api.github.com/gists/${gistId}`);
                if (!res.ok) throw new Error("Gist not found");
                const data = await res.json();
                
                const file = Object.values(data.files)[0];
                let content = file.content;
                
                // GitHub API„ÅÆÂà∂Èôê(1MB)„ÅßÂÜÖÂÆπ„ÅåÁúÅÁï•„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÁõ¥Êé•ÂèñÂæó„ÅóÁõ¥„Åô
                if (file.truncated || !content) {
                    const rawRes = await fetch(file.raw_url);
                    content = await rawRes.text();
                }

                document.body.classList.add("player-mode");
                await performLoad(content);
                setTimeout(() => play(), 1000);
            } catch (e) {
                console.error("Load Error:", e);
                alert("„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇID„ÅåÊ≠£„Åó„ÅÑ„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                document.body.classList.remove("player-mode"); // Â§±ÊïóÊôÇ„ÅØÁ∑®ÈõÜÁîªÈù¢„Å´Êàª„Åô
            }
        } else if (hash.startsWith("#p=")) {
            try {
                const json = LZString.decompressFromEncodedURIComponent(hash.replace("#p=",""));
                document.body.classList.add("player-mode");
                await performLoad(json);
                setTimeout(() => play(), 1000);
            } catch (e) {}
        }
    }

    async function performLoad(jsonData) {
        try {
            const p = JSON.parse(jsonData);
            objects = p.objects;
            for(let o of objects) { if(o.type === 'image') { o.el = new Image(); o.el.src = o.src; } }
            bg.data = p.bgData;
            if(bg.data){ bg.el = new Image(); bg.el.onload = () => draw(); bg.el.src = bg.data; }
            library = p.library || {}; initLibraryUI(); updateTimeline(); scrubTo(0); draw();
        } catch (e) { console.error("JSON Parse
